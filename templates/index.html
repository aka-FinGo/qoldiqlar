<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mebel Ombori</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="h-screen flex flex-col font-sans">

    <header class="bg-white sticky top-0 z-20 pb-2">
        <div class="px-4 py-3 flex gap-3 items-center">
            <div class="flex-1 bg-gray-100 rounded-lg flex items-center px-3 py-2">
                <i class="fas fa-search text-gray-400 mr-2"></i>
                <input type="text" id="searchInput" onkeyup="filterItems()" placeholder="Qidirish..." class="bg-transparent w-full outline-none text-sm">
            </div>
            <button onclick="toggleView()" class="text-gray-500 p-2"><i id="viewIcon" class="fas fa-th-large text-xl"></i></button>
        </div>
        <div id="categoryFilter" class="flex overflow-x-auto space-x-2 px-4 pb-1 hide-scroll">
            <button onclick="filterCat('all')" id="cat-all" class="cat-pill active px-4 py-1.5 rounded-full text-sm border bg-white whitespace-nowrap transition">Barchasi</button>
        </div>
    </header>

    <main id="mainContainer" class="flex-1 overflow-y-auto p-3 pb-24">
        <div id="loader" class="flex justify-center mt-10"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>
        <div id="remnantsList" class="grid grid-cols-2 gap-3"></div>
        <div id="emptyState" class="hidden flex flex-col items-center justify-center mt-20 text-gray-400">
            <i class="fas fa-box-open text-6xl mb-4"></i>
            <p>Hech narsa topilmadi</p>
        </div>
    </main>

    <div id="profilePage" class="hidden flex-1 overflow-y-auto p-4 pb-24 bg-gray-50">
        <div class="bg-white rounded-2xl p-6 mb-4 flex items-center shadow-sm">
            <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-2xl font-bold mr-4">
                <i class="fas fa-user"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold" id="userName">Foydalanuvchi</h2>
                <p class="text-gray-500 text-sm" id="userIdDisp">ID: ...</p>
            </div>
        </div>

        <div id="adminPanel" class="hidden mb-4">
            <div class="bg-red-50 border border-red-100 rounded-xl p-4">
                <h3 class="font-bold text-red-600 mb-2"><i class="fas fa-shield-alt"></i> Admin Panel</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button class="bg-white p-3 rounded-lg text-sm font-bold shadow-sm text-gray-700">ðŸ‘¥ Userlar</button>
                    <button class="bg-white p-3 rounded-lg text-sm font-bold shadow-sm text-gray-700">ðŸ“Š Statistika</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-1 mb-4 flex">
            <button onclick="switchProfileTab('mine')" id="ptab-mine" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-100 text-gray-800">Qo'shganlarim</button>
            <button onclick="switchProfileTab('used')" id="ptab-used" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-500">Ishlatganlarim</button>
        </div>

        <div id="profileList" class="grid grid-cols-1 gap-3"></div>
    </div>

    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white border-t py-2 px-2 z-30 flex justify-between items-end">
        <button onclick="switchTab('home')" id="nav-home" class="nav-item active flex-1 flex flex-col items-center p-2">
            <i class="fas fa-home text-xl mb-1"></i>
            <span class="text-[10px]">Bosh sahifa</span>
        </button>
        
        <button onclick="alert('Tez orada...')" class="nav-item text-gray-400 flex-1 flex flex-col items-center p-2">
            <i class="fas fa-heart text-xl mb-1"></i>
            <span class="text-[10px]">Saralangan</span>
        </button>

        <div class="relative -top-5">
            <button onclick="openModal('addModal')" class="w-14 h-14 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center text-2xl border-4 border-gray-100 transform active:scale-95 transition">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <button onclick="alert('Savat funksiyasi tez orada...')" class="nav-item text-gray-400 flex-1 flex flex-col items-center p-2">
            <i class="fas fa-shopping-cart text-xl mb-1"></i>
            <span class="text-[10px]">Savat</span>
        </button>

        <button onclick="switchTab('profile')" id="nav-profile" class="nav-item text-gray-400 flex-1 flex flex-col items-center p-2">
            <i class="fas fa-user text-xl mb-1"></i>
            <span class="text-[10px]">Profil</span>
        </button>
    </nav>

    <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:w-96 p-5 rounded-t-3xl sm:rounded-2xl h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Yangi Qoldiq</h2>
                <button onclick="closeModal('addModal')" class="bg-gray-100 p-2 rounded-full"><i class="fas fa-times"></i></button>
            </div>
            <form id="addForm" onsubmit="submitAdd(event)" class="flex-1 overflow-y-auto space-y-4 pb-10">
                <input type="hidden" name="id" id="editId">
                <div><label class="text-xs font-bold text-gray-500 ml-1">Kategoriya</label><input type="text" name="category" id="inpCat" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-blue-500" required></div>
                <div><label class="text-xs font-bold text-gray-500 ml-1">Material Nomi</label><input type="text" name="material" id="inpMat" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-blue-500" required></div>
                <div class="flex space-x-3">
                    <div class="flex-1"><label class="text-xs font-bold text-gray-500 ml-1">Eni</label><input type="number" name="width" id="inpW" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-blue-500" required></div>
                    <div class="flex-1"><label class="text-xs font-bold text-gray-500 ml-1">Bo'yi</label><input type="number" name="height" id="inpH" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-blue-500" required></div>
                </div>
                <div class="flex space-x-3">
                    <div class="w-1/3"><label class="text-xs font-bold text-gray-500 ml-1">Soni</label><input type="number" name="qty" id="inpQty" value="1" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-blue-500" required></div>
                    <div class="flex-1"><label class="text-xs font-bold text-gray-500 ml-1">Zakaz</label><input type="text" name="order" id="inpOrd" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-blue-500"></div>
                </div>
                <div><label class="text-xs font-bold text-gray-500 ml-1">Joylashuv</label><input type="text" name="location" id="inpLoc" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-blue-500"></div>
                <button type="submit" id="btnSave" class="w-full py-3.5 rounded-xl bg-blue-600 text-white font-bold text-lg shadow-lg shadow-blue-200">Saqlash</button>
            </form>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:w-96 p-5 rounded-t-3xl sm:rounded-2xl relative">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <div class="flex items-start justify-between mb-4">
                <div><span id="d-cat" class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">Kategoriya</span><h2 id="d-material" class="text-2xl font-bold mt-1 text-gray-800">Material</h2></div>
                <div id="adminActions" class="hidden">
                    <button onclick="deleteItem()" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>
                    <button onclick="editItem()" class="text-blue-500 p-2"><i class="fas fa-edit"></i></button>
                </div>
            </div>
            <div class="bg-gray-50 rounded-xl p-4 mb-5 space-y-3">
                <div class="flex justify-between border-b pb-2"><span>O'lcham</span><span id="d-size" class="font-bold"></span></div>
                <div class="flex justify-between border-b pb-2"><span>Soni</span><span id="d-qty" class="font-bold"></span></div>
                <div class="flex justify-between border-b pb-2"><span>Zakaz</span><span id="d-order"></span></div>
                <div class="flex justify-between"><span>Joy</span><span id="d-location"></span></div>
            </div>
            <button onclick="useItem()" class="w-full py-3.5 rounded-xl bg-green-500 text-white font-bold text-lg shadow-lg mb-2">Ishlatish (Olish)</button>
            <button onclick="closeModal('detailModal')" class="w-full py-3 rounded-xl text-gray-500 font-bold">Yopish</button>
        </div>
    </div>

    <script src="/static/script.js"></script>
</body>
</html>

        const userId = tg.initDataUnsafe?.user?.id || 12345; // Test uchun fallback ID

        // --- 1. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            fetchData();
        });

        // --- 2. DATA FETCHING ---
        async function fetchData(type = 'all') {
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('remnantsList').innerHTML = '';

            try {
                // API ga so'rov yuborish
                let url = `/api/remnants?user_id=${userId}&type=${type}`;
                if (currentFilterCat !== 'all') url += `&category=${currentFilterCat}`;

                const res = await fetch(url);
                itemsData = await res.json();
                renderItems();
            } catch (e) {
                alert("Xato: " + e.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        async function loadCategories() {
            try {
                const res = await fetch('/api/categories');
                const cats = await res.json();
                const container = document.getElementById('categoryFilter');
                
                cats.forEach(c => {
                    container.innerHTML += `<button onclick="filterCat('${c}')" class="px-3 py-1 rounded-full text-sm bg-gray-200 text-black whitespace-nowrap ml-2">${c}</button>`;
                });
            } catch(e) {}
        }

        // --- 3. RENDERING ---
        function renderItems() {
            const container = document.getElementById('remnantsList');
            container.innerHTML = '';
            
            // Grid/List classlarni sozlash
            if (currentViewMode === 'grid') {
                container.className = 'grid grid-cols-2 gap-3 pb-20';
            } else {
                container.className = 'flex flex-col gap-2 pb-20';
            }

            itemsData.forEach(item => {
                const div = document.createElement('div');
                div.className = `card p-3 rounded-xl shadow-sm relative active:scale-95 transition-transform ${currentViewMode === 'list' ? 'flex justify-between items-center' : ''}`;
                div.onclick = () => openDetail(item);

                if (currentViewMode === 'grid') {
                    div.innerHTML = `
                        <div class="text-xs text-gray-400 font-bold uppercase">${item.category}</div>
                        <div class="font-bold text-sm truncate mb-1">${item.material}</div>
                        <div class="text-lg font-bold text-blue-500">${item.width} x ${item.height}</div>
                        <div class="text-xs text-gray-500 mt-1"><i class="fas fa-box"></i> ${item.qty} ta &bull; <i class="fas fa-map-marker-alt"></i> ${item.location || '-'}</div>
                    `;
                } else {
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-sm">${item.category} ${item.material}</div>
                            <div class="text-xs text-gray-500">${item.width}x${item.height} | ${item.qty} ta | ${item.location}</div>
                        </div>
                        <div class="text-blue-500 font-bold"><i class="fas fa-chevron-right"></i></div>
                    `;
                }
                container.appendChild(div);
            });
        }

        // --- 4. ACTIONS ---
        function filterCat(cat) {
            currentFilterCat = cat;
            // Button stillarini o'zgartirish (soddalashtirilgan)
            fetchData(currentTab === 'profile' ? 'mine' : 'all');
        }

        function toggleView() {
            currentViewMode = currentViewMode === 'grid' ? 'list' : 'grid';
            document.getElementById('viewIcon').className = currentViewMode === 'grid' ? 'fas fa-th-large' : 'fas fa-list';
            renderItems();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-home').classList.toggle('active-tab', tab === 'home');
            document.getElementById('tab-home').classList.toggle('text-gray-400', tab !== 'home');
            document.getElementById('tab-profile').classList.toggle('active-tab', tab === 'profile');
            document.getElementById('tab-profile').classList.toggle('text-gray-400', tab !== 'profile');
            
            // Profilga o'tganda "Menikilar" ni yuklaymiz
            fetchData(tab === 'profile' ? 'mine' : 'all');
        }

        // --- 5. MODAL LOGIC ---
        function openDetail(item) {
            selectedItem = item;
            document.getElementById('d-material').innerText = item.material;
            document.getElementById('d-category').innerText = item.category;
            document.getElementById('d-size').innerText = `${item.width} x ${item.height} mm`;
            document.getElementById('d-qty').innerText = `${item.qty} ta`;
            document.getElementById('d-order').innerText = item.origin_order || '-';
            document.getElementById('d-location').innerText = item.location || '-';
            
            document.getElementById('detailModal').classList.remove('hidden');
        }

        async function useItem() {
            if(!selectedItem) return;
            if(!confirm("Haqiqatan ham ishlatmoqchimisiz?")) return;
            
            await fetch('/api/use', {
                method: 'POST',
                body: JSON.stringify({id: selectedItem.id, user_id: userId})
            });
            
            closeModal('detailModal');
            fetchData(currentTab === 'profile' ? 'mine' : 'all');
            tg.HapticFeedback.notificationOccurred('success');
        }

        async function submitAdd(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.user_id = userId;
            
            await fetch('/api/add', { method: 'POST', body: JSON.stringify(data) });
            
            e.target.reset();
            closeModal('addModal');
            fetchData('all');
            tg.HapticFeedback.notificationOccurred('success');
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    </script>
</body>
</html>
