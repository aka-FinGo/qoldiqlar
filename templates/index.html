<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mebel Ombori</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
        .card { background-color: var(--tg-theme-secondary-bg-color, #f5f5f5); }
        .btn-primary { background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); }
        .active-tab { color: var(--tg-theme-button-color, #3390ec); border-bottom: 2px solid var(--tg-theme-button-color, #3390ec); }
        /* Scrollbar yashirish */
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="p-3 shadow-sm z-10">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-lg font-bold">Ombor</h1>
            <button onclick="toggleView()" class="p-2 rounded card"><i id="viewIcon" class="fas fa-th-large"></i></button>
        </div>
        <div id="categoryFilter" class="flex overflow-x-auto space-x-2 hide-scroll pb-1">
            <button onclick="filterCat('all')" class="px-3 py-1 rounded-full text-sm bg-gray-200 text-black whitespace-nowrap active-cat">Barchasi</button>
            </div>
    </header>

    <main id="mainContainer" class="flex-1 overflow-y-auto p-3 pb-20 relative">
        <div id="remnantsList" class="grid grid-cols-2 gap-3 transition-all">
            </div>
        
        <div id="loader" class="text-center mt-10 hidden">
            <i class="fas fa-spinner fa-spin text-2xl"></i>
        </div>
    </main>

    <button onclick="openModal('addModal')" class="absolute bottom-20 right-4 w-14 h-14 rounded-full btn-primary shadow-lg flex items-center justify-center text-2xl z-20">
        <i class="fas fa-plus"></i>
    </button>

    <nav class="p-2 border-t flex justify-around items-center bg-white z-30" style="background-color: var(--tg-theme-bg-color);">
        <button onclick="switchTab('home')" id="tab-home" class="flex flex-col items-center w-1/2 active-tab py-1">
            <i class="fas fa-warehouse text-xl"></i>
            <span class="text-xs">Ombor</span>
        </button>
        <button onclick="switchTab('profile')" id="tab-profile" class="flex flex-col items-center w-1/2 text-gray-400 py-1">
            <i class="fas fa-user text-xl"></i>
            <span class="text-xs">Profil</span>
        </button>
    </nav>

    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-96 p-5 rounded-t-2xl sm:rounded-2xl relative" style="background-color: var(--tg-theme-bg-color);">
            <button onclick="closeModal('detailModal')" class="absolute top-3 right-3 text-gray-500"><i class="fas fa-times text-xl"></i></button>
            
            <h2 id="d-material" class="text-xl font-bold mb-1">LDSP Oq</h2>
            <p id="d-category" class="text-sm text-gray-500 mb-4">Kategoriya</p>
            
            <div class="space-y-2 mb-5">
                <div class="flex justify-between border-b pb-1"><span>O'lcham:</span> <span id="d-size" class="font-bold"></span></div>
                <div class="flex justify-between border-b pb-1"><span>Soni:</span> <span id="d-qty" class="font-bold"></span></div>
                <div class="flex justify-between border-b pb-1"><span>Zakaz:</span> <span id="d-order"></span></div>
                <div class="flex justify-between border-b pb-1"><span>Joy:</span> <span id="d-location"></span></div>
            </div>

            <button id="btnUse" onclick="useItem()" class="w-full py-3 rounded-xl btn-primary font-bold mb-2">
                <i class="fas fa-check"></i> Ishlatish (Olish)
            </button>
        </div>
    </div>

    <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-96 p-5 rounded-t-2xl sm:rounded-2xl h-3/4 overflow-y-auto" style="background-color: var(--tg-theme-bg-color);">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Yangi Qoldiq</h2>
                <button onclick="closeModal('addModal')"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <form id="addForm" onsubmit="submitAdd(event)" class="space-y-3">
                <input type="text" name="category" placeholder="Kategoriya (MDF, LDSP)" class="w-full p-3 rounded card border-none outline-none" required>
                <input type="text" name="material" placeholder="Material Rangi/Nomi" class="w-full p-3 rounded card border-none outline-none" required>
                <div class="flex space-x-2">
                    <input type="number" name="width" placeholder="Eni (mm)" class="w-1/2 p-3 rounded card border-none outline-none" required>
                    <input type="number" name="height" placeholder="Bo'yi (mm)" class="w-1/2 p-3 rounded card border-none outline-none" required>
                </div>
                <input type="number" name="qty" placeholder="Soni" value="1" class="w-full p-3 rounded card border-none outline-none" required>
                <input type="text" name="order" placeholder="Zakaz raqami" class="w-full p-3 rounded card border-none outline-none">
                <input type="text" name="location" placeholder="Joylashuv" class="w-full p-3 rounded card border-none outline-none">
                
                <button type="submit" class="w-full py-3 rounded-xl btn-primary font-bold mt-4">Saqlash</button>
            </form>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // Full screen

        let currentViewMode = 'grid'; // grid | list
        let currentTab = 'home'; // home | profile
        let currentFilterCat = 'all';
        let itemsData = [];
        let selectedItem = null;

        const userId = tg.initDataUnsafe?.user?.id || 12345; // Test uchun fallback ID

        // --- 1. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            fetchData();
        });

        // --- 2. DATA FETCHING ---
        async function fetchData(type = 'all') {
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('remnantsList').innerHTML = '';

            try {
                // API ga so'rov yuborish
                let url = `/api/remnants?user_id=${userId}&type=${type}`;
                if (currentFilterCat !== 'all') url += `&category=${currentFilterCat}`;

                const res = await fetch(url);
                itemsData = await res.json();
                renderItems();
            } catch (e) {
                alert("Xato: " + e.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        async function loadCategories() {
            try {
                const res = await fetch('/api/categories');
                const cats = await res.json();
                const container = document.getElementById('categoryFilter');
                
                cats.forEach(c => {
                    container.innerHTML += `<button onclick="filterCat('${c}')" class="px-3 py-1 rounded-full text-sm bg-gray-200 text-black whitespace-nowrap ml-2">${c}</button>`;
                });
            } catch(e) {}
        }

        // --- 3. RENDERING ---
        function renderItems() {
            const container = document.getElementById('remnantsList');
            container.innerHTML = '';
            
            // Grid/List classlarni sozlash
            if (currentViewMode === 'grid') {
                container.className = 'grid grid-cols-2 gap-3 pb-20';
            } else {
                container.className = 'flex flex-col gap-2 pb-20';
            }

            itemsData.forEach(item => {
                const div = document.createElement('div');
                div.className = `card p-3 rounded-xl shadow-sm relative active:scale-95 transition-transform ${currentViewMode === 'list' ? 'flex justify-between items-center' : ''}`;
                div.onclick = () => openDetail(item);

                if (currentViewMode === 'grid') {
                    div.innerHTML = `
                        <div class="text-xs text-gray-400 font-bold uppercase">${item.category}</div>
                        <div class="font-bold text-sm truncate mb-1">${item.material}</div>
                        <div class="text-lg font-bold text-blue-500">${item.width} x ${item.height}</div>
                        <div class="text-xs text-gray-500 mt-1"><i class="fas fa-box"></i> ${item.qty} ta &bull; <i class="fas fa-map-marker-alt"></i> ${item.location || '-'}</div>
                    `;
                } else {
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-sm">${item.category} ${item.material}</div>
                            <div class="text-xs text-gray-500">${item.width}x${item.height} | ${item.qty} ta | ${item.location}</div>
                        </div>
                        <div class="text-blue-500 font-bold"><i class="fas fa-chevron-right"></i></div>
                    `;
                }
                container.appendChild(div);
            });
        }

        // --- 4. ACTIONS ---
        function filterCat(cat) {
            currentFilterCat = cat;
            // Button stillarini o'zgartirish (soddalashtirilgan)
            fetchData(currentTab === 'profile' ? 'mine' : 'all');
        }

        function toggleView() {
            currentViewMode = currentViewMode === 'grid' ? 'list' : 'grid';
            document.getElementById('viewIcon').className = currentViewMode === 'grid' ? 'fas fa-th-large' : 'fas fa-list';
            renderItems();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-home').classList.toggle('active-tab', tab === 'home');
            document.getElementById('tab-home').classList.toggle('text-gray-400', tab !== 'home');
            document.getElementById('tab-profile').classList.toggle('active-tab', tab === 'profile');
            document.getElementById('tab-profile').classList.toggle('text-gray-400', tab !== 'profile');
            
            // Profilga o'tganda "Menikilar" ni yuklaymiz
            fetchData(tab === 'profile' ? 'mine' : 'all');
        }

        // --- 5. MODAL LOGIC ---
        function openDetail(item) {
            selectedItem = item;
            document.getElementById('d-material').innerText = item.material;
            document.getElementById('d-category').innerText = item.category;
            document.getElementById('d-size').innerText = `${item.width} x ${item.height} mm`;
            document.getElementById('d-qty').innerText = `${item.qty} ta`;
            document.getElementById('d-order').innerText = item.origin_order || '-';
            document.getElementById('d-location').innerText = item.location || '-';
            
            document.getElementById('detailModal').classList.remove('hidden');
        }

        async function useItem() {
            if(!selectedItem) return;
            if(!confirm("Haqiqatan ham ishlatmoqchimisiz?")) return;
            
            await fetch('/api/use', {
                method: 'POST',
                body: JSON.stringify({id: selectedItem.id, user_id: userId})
            });
            
            closeModal('detailModal');
            fetchData(currentTab === 'profile' ? 'mine' : 'all');
            tg.HapticFeedback.notificationOccurred('success');
        }

        async function submitAdd(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.user_id = userId;
            
            await fetch('/api/add', { method: 'POST', body: JSON.stringify(data) });
            
            e.target.reset();
            closeModal('addModal');
            fetchData('all');
            tg.HapticFeedback.notificationOccurred('success');
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    </script>
</body>
</html>
